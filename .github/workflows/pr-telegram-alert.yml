name: Notify Telegram on PR

on:
  pull_request:
    types: [opened, reopened]
    branches:
      - dev

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ vars.TELEGRAM_CHAT_ID }}
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–±—ã—Ç–∏—è PR
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          PR_URL="${{ github.event.pull_request.html_url }}"

          # # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–≤—å—é–µ—Ä–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          # REVIEWERS=""
          # for reviewer in ${{ toJSON(github.event.pull_request.requested_reviewers) }}; do
          #   # –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± ‚Äî –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤ –Ω–µ –ø—É—Å—Ç, –ø–æ–∫–∞–∂–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
          #   # –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –Ω—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å JSON, –Ω–æ –≤ bash —ç—Ç–æ —Å–ª–æ–∂–Ω–æ
          #   # –ü–æ—ç—Ç–æ–º—É —Å–¥–µ–ª–∞–µ–º —á–µ—Ä–µ–∑ jq, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî —Å–º. –Ω–∏–∂–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
          #   break
          # done

          # # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–≤—å—é–µ—Ä–æ–≤
          # REVIEWER_COUNT=$(echo '${{ toJSON(github.event.pull_request.requested_reviewers) }}' | jq 'length' 2>/dev/null || echo "0")
          # if [ "$REVIEWER_COUNT" -gt 0 ]; then
          #   REVIEWERS_TEXT="üë• *–†–µ–≤—å—é–µ—Ä—ã:* $REVIEWER_COUNT —á–µ–ª–æ–≤–µ–∫(–∞)"
          # else
          #   REVIEWERS_TEXT="üë• *–†–µ–≤—å—é–µ—Ä—ã:* –ø–æ–∫–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã"
          # fi

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="üÜï *–ù–æ–≤—ã–π Pull Request!*%0A%0A"
          MESSAGE+="üìù *–ù–∞–∑–≤–∞–Ω–∏–µ:* $PR_TITLE%0A"
          MESSAGE+="üë§ *–ê–≤—Ç–æ—Ä:* @$PR_AUTHOR%0A"
          MESSAGE+="üåø *–ò–∑ –≤–µ—Ç–∫–∏:* \`$PR_SOURCE_BRANCH\`%0A"
          MESSAGE+="‚û°Ô∏è *–í –≤–µ—Ç–∫—É:* \`$PR_TARGET_BRANCH\`%0A"
          MESSAGE+="$REVIEWERS_TEXT%0A"
          MESSAGE+="üîó [–û—Ç–∫—Ä—ã—Ç—å PR]($PR_URL)%0A"
          MESSAGE+="_–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ GitHub Actions_"

          curl -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"
